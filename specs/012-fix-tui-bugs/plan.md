# Implementation Plan: Fix TUI Bugs

**Branch**: `002-fix-tui-bugs` | **Date**: 2026-01-29 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/012-fix-tui-bugs/spec.md`

## Summary

Fix 5 TUI bugs affecting user experience: terminal copy/paste restoration (#197), dashboard auto-refresh after batch update (#199), ESC navigation after install/uninstall (#200), multi-line location display (#201), and stray character elimination (#196). All fixes target the existing Go TUI codebase using Bubbletea framework.

## Technical Context

**Language/Version**: Go 1.23+
**Primary Dependencies**: Bubbletea (TUI framework), Lipgloss (styling), Bubbles (components)
**Storage**: N/A (in-memory state only)
**Testing**: Manual verification via `go run ./cmd/installer`, `go build`, `go vet`, `go fmt`
**Project Type**: Single project (TUI application)
**Performance Goals**: N/A (bug fixes, not performance optimization)
**Constraints**: Must not break existing TUI functionality; all changes confined to existing files
**Scale/Scope**: ~5 files modified, ~50-100 lines changed across all fixes

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Script Consolidation | PASS | No new scripts; modifying existing Go code only |
| II. Branch Preservation | PASS | Using feature branch `002-fix-tui-bugs` |
| III. Local-First CI/CD | PASS | Will verify with `go build`, `go vet` locally before any push |
| IV. Modularity Limits | PASS | No file will exceed 300 lines delta; targeted fixes only |
| V. Symlink Single Source | PASS | Not touching AGENTS.md, CLAUDE.md, or GEMINI.md |

**Protected Files Check**: None affected.

**Pre-Design Gate**: PASSED - All constitutional principles satisfied.

## Project Structure

### Documentation (this feature)

```text
specs/012-fix-tui-bugs/
├── plan.md              # This file
├── research.md          # Phase 0 output (root cause analysis)
├── spec.md              # Feature specification
├── checklists/          # Validation checklists
│   └── requirements.md  # Spec quality checklist
└── tasks.md             # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```text
tui/
├── cmd/
│   └── installer/
│       └── main.go          # Bug #197: Terminal state cleanup
└── internal/
    ├── ui/
    │   ├── model.go         # Bug #199, #200: Navigation & refresh logic
    │   ├── tooldetail.go    # Bug #201: Multi-line location display
    │   └── [other views]    # Bug #196: Rendering investigation
    └── cache/
        └── cache.go         # Bug #201: Location parsing (already correct)
```

**Structure Decision**: Existing single-project TUI structure. All fixes are within the `tui/` directory, targeting specific Go files based on root cause analysis.

## Complexity Tracking

> No violations to justify - this is a targeted bug fix task.

| Violation | Why Needed | Simpler Alternative Rejected Because |
|-----------|------------|-------------------------------------|
| None | N/A | N/A |

## Implementation Approach

### Bug #197 - Terminal State Restoration

**Root Cause**: `tea.WithAltScreen()` and `tea.ExecProcess()` interactions leave terminal in bad state.

**Fix Location**: `tui/cmd/installer/main.go`

**Approach**:
1. Add signal handling for SIGINT/SIGTERM with cleanup
2. Ensure deferred terminal restoration on program exit
3. Consider explicit terminal mode reset after subprocess execution

### Bug #199 - Dashboard Auto-Refresh

**Root Cause**: Batch update completion calls `refreshAllStatuses()` but no loading indicator shown.

**Fix Location**: `tui/internal/ui/model.go` (lines ~358-370)

**Approach**:
1. Set `m.loading = true` when returning to Dashboard from batch completion
2. Ensure status cache is invalidated for updated tools
3. Show loading spinner while refresh runs

### Bug #200 - ESC Navigation After Install

**Root Cause**: `InstallerExitMsg` handler doesn't preserve navigation state properly.

**Fix Location**: `tui/internal/ui/model.go` (lines ~306-338)

**Approach**:
1. Store `previousView` before launching installer from tool detail
2. Restore to ViewToolDetail (not parent menu) on InstallerExitMsg
3. Refresh tool status in detail view after return

### Bug #201 - Multi-Line Location Display

**Root Cause**: `renderRow()` only shows `status.Location`, ignoring `status.Details` array.

**Fix Location**: `tui/internal/ui/tooldetail.go` (lines ~249-253)

**Approach**:
1. Check if `status.Details` array has additional location lines
2. Render all location lines with proper indentation/alignment
3. Maintain visual consistency with other fields

### Bug #196 - Stray Character Elimination

**Root Cause**: Unknown - likely rendering artifact from spinner or escape sequences.

**Fix Location**: To be determined through investigation

**Approach**:
1. Investigate spinner animation and styling
2. Check for mouse input leakage
3. Verify terminal escape sequence handling
4. Add screen clearing before re-renders if needed

## Verification Steps

1. `go fmt ./...` → No formatting issues
2. `go vet ./...` → No static analysis errors
3. `go build ./...` → Compilation succeeds
4. Manual testing of each bug fix scenario per spec acceptance criteria

## Post-Design Constitution Check

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Script Consolidation | PASS | No scripts created |
| II. Branch Preservation | PASS | Branch preserved |
| III. Local-First CI/CD | PASS | Local verification planned |
| IV. Modularity Limits | PASS | Targeted fixes, no oversized files |
| V. Symlink Single Source | PASS | No symlinks touched |

**Post-Design Gate**: PASSED
