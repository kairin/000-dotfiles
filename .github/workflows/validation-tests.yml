name: Configuration & Code Validation

# Validation tests triggered on pull requests and feature branches
# Runs local CI/CD scripts for shell validation, config checks, and performance tests
# Zero GitHub Actions cost - only validation, no deployment

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    paths:
      - 'configs/**'
      - 'scripts/**'
      - 'astro-website/**'
      - 'start.sh'
      - 'manage.sh'
      - '.github/workflows/validation-tests.yml'
  workflow_dispatch:

permissions:
  contents: read
  checks: write

env:
  LOG_DIR: /tmp/ci-validation-logs

jobs:
  # Shell script validation
  shellcheck:
    name: ShellCheck - Script Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: |
          apt-get update > /dev/null 2>&1 && \
          apt-get install -y shellcheck > /dev/null 2>&1 || \
          echo "ShellCheck already installed or installation skipped"

      - name: Run ShellCheck on shell scripts
        run: |
          echo "Running ShellCheck on shell scripts..."
          find scripts -name "*.sh" -exec shellcheck --severity=error {} \;
          shellcheck --severity=error start.sh
          echo "✓ ShellCheck validation passed (no errors)"

      - name: ShellCheck Results
        if: always()
        run: echo "Shell script validation completed"

  # TypeScript and Build validation
  typescript-check:
    name: TypeScript Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '25'
          cache: 'npm'
          cache-dependency-path: 'astro-website/package-lock.json'

      - name: Install website dependencies
        working-directory: ./astro-website
        run: npm ci --silent

      - name: Run TypeScript check
        working-directory: ./astro-website
        run: npm run check
        continue-on-error: false

      - name: Verify TypeScript strict mode
        working-directory: ./astro-website
        run: |
          echo "Verifying TypeScript configuration..."
          if grep -q '"strict": true' tsconfig.json; then
            echo "✓ TypeScript strict mode enabled"
          else
            echo "⚠ TypeScript strict mode not enabled"
          fi

  # Performance baseline check
  performance-check:
    name: Performance Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create logs directory
        run: mkdir -p "$LOG_DIR"

      - name: System information
        run: |
          echo "System Information for Performance Validation:"
          echo "Hostname: $(hostname)"
          echo "Kernel: $(uname -r)"
          echo "Uptime: $(uptime)"
          echo "CPU cores: $(nproc)"
          echo "Available memory: $(free -h | grep Mem | awk '{print $7}')"

      - name: Validate installation scripts
        run: |
          echo "Validating installation script structure..."

          if [ -f "start.sh" ]; then
            # Check for error handling
            if grep -q "set -euo pipefail" start.sh; then
              echo "✓ Error handling enabled in start.sh"
            else
              echo "⚠ start.sh missing robust error handling"
            fi

            # Check for logging
            if grep -q "log\|echo" start.sh; then
              echo "✓ Logging enabled in start.sh"
            fi
          fi

  # Critical file preservation check
  critical-files-check:
    name: Critical Files Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Verify .nojekyll presence
        run: |
          echo "Verifying critical .nojekyll file..."
          if [ ! -f "docs/.nojekyll" ]; then
            echo "ERROR: docs/.nojekyll missing - CRITICAL for GitHub Pages!"
            exit 1
          fi
          echo "✓ .nojekyll file verified"

      - name: Verify documentation structure
        run: |
          echo "Validating documentation structure..."

          # Check for required documentation directories
          REQUIRED_DIRS=("website/src" "documentations" "configs")
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$dir" ]; then
              echo "✓ Directory found: $dir"
            else
              echo "⚠ Directory missing: $dir"
            fi
          done

      - name: Check backup mechanism
        run: |
          echo "Checking for configuration backup mechanism..."

          if grep -r "backup\|timestamp" scripts/ 2>/dev/null | grep -q "\."; then
            echo "✓ Backup mechanism detected"
          else
            echo "⚠ No backup mechanism detected"
          fi

  # Summary report
  validation-summary:
    name: Validation Summary
    needs: [shellcheck, typescript-check, performance-check, critical-files-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check validation results
        run: |
          echo "Validation Results Summary:"
          echo "=========================================="
          echo "✓ ShellCheck: Completed"
          echo "✓ TypeScript: Checked"
          echo "✓ Performance: Assessed"
          echo "✓ Critical Files: Verified"
          echo "=========================================="
          echo "All validation checks completed successfully!"
